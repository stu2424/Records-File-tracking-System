<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>File Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="assets/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
  body { background-color: #f8f9fa; }
  .history-log { font-size: 0.85rem; white-space: pre-line; max-height: 80px; overflow-y: auto; word-break: break-word; }
  .card-header { font-weight: bold; background-color: #0d6efd; color: white; }
  @media print { .no-print { display:none !important; } }
  #fileTable thead { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
  .stats-card { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <i class="bi bi-folder2-open-fill me-2"></i> File Tracking System
    </a>
    <div class="d-flex ms-auto align-items-center">
      <span class="navbar-text me-3" id="welcomeUser"></span>
      <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-3">

  <h3 id="categoryTitle" class="text-center mb-3"></h3>
  <button class="btn btn-secondary mb-3 no-print" onclick="window.location='dashboard.html'">‚Üê Back to Dashboard</button>

  <!-- Stats Cards -->
  <div class="row mb-3 g-2">
    <div class="col-md-4">
      <div class="card stats-card text-center bg-light">
        <h6>Total Files</h6>
        <span id="totalFiles">0</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card text-center bg-light">
        <h6>Pending</h6>
        <span id="pendingFiles">0</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card text-center bg-light">
        <h6>Overdue</h6>
        <span id="overdueFiles">0</span>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 no-print gap-2">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <button class="btn btn-outline-danger btn-sm" onclick="resetAll()"><i class="bi bi-trash"></i> Reset All</button>
      <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()"><i class="bi bi-file-earmark-excel"></i> Export</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Print</button>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search title or ref" oninput="renderTable()" style="min-width:180px;">
      <label class="mb-0" for="filterFrom">From:</label>
      <input type="date" id="filterFrom" class="form-control form-control-sm" onchange="renderTable()">
      <label class="mb-0" for="filterTo">To:</label>
      <input type="date" id="filterTo" class="form-control form-control-sm" onchange="renderTable()">
    </div>
  </div>

  <!-- Add File -->
  <div class="card mb-4 no-print">
    <div class="card-header">Add New File</div>
    <div class="card-body">
      <form id="fileForm" class="row g-2">
        <div class="col-md-5 col-12"><input type="text" class="form-control" id="fileTitle" placeholder="File Title" required></div>
        <div class="col-md-5 col-12"><input type="text" class="form-control" id="refNumber" placeholder="Reference Number" required></div>
        <div class="col-md-2 col-12 d-grid"><button type="submit" class="btn btn-primary">Add File</button></div>
      </form>
    </div>
  </div>

  <!-- File Table -->
  <div class="card table-responsive">
    <div class="card-header">Tracked Files</div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover align-middle mb-0" id="fileTable">
        <thead class="table-light">
          <tr>
            <th>#</th><th>Title</th><th>Reference</th><th>Created</th>
            <th>Last Updated</th><th>Current Location</th><th>History</th><th>Status</th>
            <th class="no-print">Update Location</th><th class="no-print">Delete</th>
          </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script src="assets/js/bootstrap.bundle.min.js"></script>
<script>
const currentUser = localStorage.getItem('currentUser') || 'Guest';
document.getElementById('welcomeUser').innerText = `Welcome ${currentUser}`;

const LOCATIONS = ['Records','Technical','Surveys','Finance','Adjudication','Board','Sub Land board Secretary','Deputy Sub Land Board Secretary','Land Use','Land Registration'];

const params = new URLSearchParams(window.location.search);
const CATEGORY = params.get('cat') || 'General';
document.getElementById('categoryTitle').innerText = CATEGORY;

let allFiles = JSON.parse(localStorage.getItem('allFiles') || '{}');
let files = allFiles[CATEGORY] || [];

function saveToLocal(){ allFiles[CATEGORY]=files; localStorage.setItem('allFiles', JSON.stringify(allFiles)); }

document.getElementById('fileForm').addEventListener('submit', function(e){
  e.preventDefault();
  const title = document.getElementById('fileTitle').value.trim();
  const ref = document.getElementById('refNumber').value.trim();
  if(!title||!ref){ alert('Fill both fields'); return; }
  if(files.find(f=>f.ref.toLowerCase()===ref.toLowerCase())){ alert('Reference exists'); return; }
  const nowISO=new Date().toISOString();
  const nowDisplay=new Date().toLocaleString();
  files.push({ title, ref, created: nowISO, lastUpdated: nowISO, currentLocation:'Records', history:[`[${nowDisplay}] Created at Records`] });
  saveToLocal();
  this.reset(); renderTable();
});

function renderTable(){
  const tbody = document.getElementById('fileTableBody'); tbody.innerHTML='';
  const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const fromDate = document.getElementById('filterFrom')?.value;
  const toDate = document.getElementById('filterTo')?.value;

  let total=0, pending=0, overdue=0;

  files.forEach((file,index)=>{
    const createdDate = file.created.slice(0,10);
    const matchesSearch = file.title.toLowerCase().includes(searchQuery) || file.ref.toLowerCase().includes(searchQuery);
    const afterFrom = fromDate ? createdDate >= fromDate : true;
    const beforeTo = toDate ? createdDate <= toDate : true;
    if(!(matchesSearch && afterFrom && beforeTo)) return;

    const now=new Date(), created=new Date(file.created), diffMinutes=(now-created)/(1000*60);
    let status='', statusClass=''; 
    if(diffMinutes<=1){ status='Pending'; statusClass='text-success'; pending++; } 
    else{ status='Overdue'; statusClass='text-danger fw-bold'; overdue++; }
    total++;

    const lastHistory=file.history.slice(-5).join('\n');
    const realIndex=index;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${file.title}</td>
      <td>${file.ref}</td>
      <td>${new Date(file.created).toLocaleString()}</td>
      <td>${new Date(file.lastUpdated).toLocaleString()}</td>
      <td>${file.currentLocation}</td>
      <td class="history-log" title="${file.history.join('\n')}">${lastHistory}</td>
      <td class="${statusClass}">${status}</td>
      <td class="no-print">
        <div class="input-group">
          <select class="form-select form-select-sm" id="loc-${realIndex}">
            <option value="" disabled>Select location</option>
            ${LOCATIONS.map(loc=>loc===file.currentLocation?`<option selected>${loc}</option>`:`<option>${loc}</option>`).join('')}
          </select>
          <button class="btn btn-sm btn-outline-primary" onclick="updateLocation(${realIndex})">Update</button>
        </div>
      </td>
      <td class="no-print text-center">
        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${realIndex})"><i class="bi bi-trash"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalFiles').innerText=total;
  document.getElementById('pendingFiles').innerText=pending;
  document.getElementById('overdueFiles').innerText=overdue;
}

function updateLocation(index){
  const select=document.getElementById(`loc-${index}`); const newLoc=select.value;
  if(!newLoc){ alert('Select valid location'); return; }
  const nowISO=new Date().toISOString();
  const nowDisplay=new Date().toLocaleString();
  files[index].currentLocation=newLoc;
  files[index].lastUpdated=nowISO;
  files[index].history.push(`[${nowDisplay}] Moved to ${newLoc}`);
  saveToLocal(); renderTable();
}

function deleteFile(index){ if(confirm(`Delete "${files[index].title}"?`)){ files.splice(index,1); saveToLocal(); renderTable(); } }
function resetAll(){ if(confirm('Clear all files in this category?')){ files=[]; saveToLocal(); renderTable(); } }

function exportToExcel(){
  let html=`<table border="1"><tr><th>#</th><th>Title</th><th>Reference</th><th>Created</th><th>Last Updated</th><th>Current Location</th><th>History</th><th>Status</th></tr>`;
  files.forEach((file,i)=>{
    const now=new Date(), created=new Date(file.created), diffMinutes=(now-created)/(1000*60);
    const status=diffMinutes<=1?'Pending':'Overdue';
    html+=`<tr>
      <td>${i+1}</td><td>${file.title}</td><td>${file.ref}</td>
      <td>${new Date(file.created).toLocaleString()}</td>
      <td>${new Date(file.lastUpdated).toLocaleString()}</td>
      <td>${file.currentLocation}</td>
      <td>${file.history.join('\n')}</td>
      <td>${status}</td>
    </tr>`;
  });
  html+='</table>';
  const blob=new Blob([html], {type:'application/vnd.ms-excel'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='file_tracking_export.xls'; a.click();
}

function logout(){ localStorage.removeItem('currentUser'); window.location.href='login.html'; }

renderTable();
</script>
</body>
</html>
